@page "/supervisor/approvals"
@attribute [Authorize(Roles = "Supervisor")]
@using GovConMoney.Domain.Entities
@using GovConMoney.Domain.Enums
@using GovConMoney.Application.Abstractions
@inject GovConMoney.Infrastructure.Persistence.InMemoryDataStore Store
@inject ITenantContext TenantContext

<h3>Supervisor - Timesheet Approvals</h3>

<table class="table">
    <thead><tr><th>Timesheet</th><th>Employee</th><th>Period</th><th>Status</th><th>Pending Expenses</th><th></th></tr></thead>
    <tbody>
    @foreach (var row in Store.Timesheets
        .Where(x => x.TenantId == TenantContext.TenantId && x.Status == TimesheetStatus.Submitted)
        .Where(x => Store.PersonnelProfiles.Any(p => p.TenantId == TenantContext.TenantId && p.UserId == x.UserId && p.SupervisorUserId == TenantContext.UserId))
        .OrderByDescending(x => x.SubmittedAtUtc))
    {
        var pendingExpenses = Store.TimesheetExpenses
            .Where(x => x.TimesheetId == row.Id && x.Status == ExpenseStatus.PendingApproval)
            .OrderByDescending(x => x.ExpenseDate)
            .ToList();
        <tr>
            <td>@row.Id</td>
            <td>@Store.Users.Single(x => x.Id == row.UserId).UserName</td>
            <td>@row.PeriodStart - @row.PeriodEnd</td>
            <td>@row.Status</td>
            <td>@pendingExpenses.Count</td>
            <td>
                <form method="post" action="/api/supervisor/timesheets/@row.Id/approve-form">
                    <button class="btn btn-sm btn-success" type="submit">Approve</button>
                </form>
            </td>
        </tr>

        @if (pendingExpenses.Count > 0)
        {
            <tr>
                <td colspan="6">
                    <div class="p-2 border rounded bg-light-subtle">
                        <strong>Expense Approvals</strong>
                        <table class="table table-sm mb-0 mt-2">
                            <thead>
                                <tr><th>Date</th><th>Charge Code</th><th>Amount</th><th>Category</th><th>Description</th><th>Actions</th></tr>
                            </thead>
                            <tbody>
                            @foreach (var expense in pendingExpenses)
                            {
                                <tr>
                                    <td>@expense.ExpenseDate</td>
                                    <td>@Store.ChargeCodes.FirstOrDefault(x => x.Id == expense.ChargeCodeId)?.Code</td>
                                    <td>@expense.Amount.ToString("C")</td>
                                    <td>@expense.Category</td>
                                    <td>@expense.Description</td>
                                    <td>
                                        <div class="d-flex gap-1 align-items-center">
                                            <form method="post" action="/api/supervisor/timesheets/@row.Id/expenses/@expense.Id/approve-form">
                                                <button class="btn btn-sm btn-outline-success" type="submit">Approve</button>
                                            </form>
                                            <form method="post" action="/api/supervisor/timesheets/@row.Id/expenses/@expense.Id/reject-form" class="d-flex gap-1">
                                                <input name="reason" class="form-control form-control-sm" placeholder="Rejection reason" />
                                                <button class="btn btn-sm btn-outline-danger" type="submit">Reject</button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                            }
                            </tbody>
                        </table>
                    </div>
                </td>
            </tr>
        }
    }
    </tbody>
</table>
